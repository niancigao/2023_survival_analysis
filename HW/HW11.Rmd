---
title: "Time Series HW11"
author: "B082040005 高念慈"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=F, results='hide', message=FALSE, warning=FALSE}
# require(quantmod)  # 股價
require(moments)   # 偏、峰度
# install.packages("fUnitRoots")
library(fBasics)
# install.packages('https://cran.r-project.org/src/contrib/Archive/normtest/normtest_1.1.tar.gz')
library(normtest)

library(TSA)
library(fUnitRoots)
# library(ggplot2)

require(sandwich)
require(lmtest)

```

## 1. 
Consider the daily simple returns of IBM stock, CRSP value-weighted <br>
index, CRSP equal-weighted index, and the S&P composite index <br>
from January 1980 to December 2008. The index returns include <br>
dividend distributions. The data file is d-ibm3dxwkdays8008.txt, <br>
which has 12 columns. The columns are (year, month, day, IBM, VW, <br>
EW, SP, M, T, W, H, F), where M, T, W, R, and F denotes indicator <br>
variables for Monday to Friday, respectively. 

### the daily simple returns

```{r}
data4 = read.table("https://faculty.chicagobooth.edu/-/media/faculty/ruey-s-tsay/teaching/fts3/d-ibm3dxwkdays8008.txt", header=T)
head(data4)
```

(a) Use a regression model <br>
to study the effects of trading days on the equal-weighted index returns. <br> 
What is the fitted model? Are the weekday effects significant in the <br>
returns at the 5% level?

### What is the fitted model? 

```{r}
ml = lm(ew ~ M+T+W+R+F, data=data4)
summary(ml)
step(ml)
```

```{r}
ml2 = lm(ew ~ M+T+W+F+R, data=data4)
summary(ml2)
step(ml2)
```

```{r}
ml3 = lm(ew ~ M+T+F+R+W, data=data4)
summary(ml3)
step(ml3)
```

```{r}
ml4 = lm(ew ~ M+W+F+R+T, data=data4)
summary(ml4)
step(ml4)
```

```{r}
ml5 = lm(ew ~ T+W+F+R+M, data=data4)
summary(ml5)
step(ml5)
```

+ AIC 最低的模型:lm(formula = ew ~ M + T + F, data = data4)

```{r}
best = lm(formula = ew ~ M + T + F, data = data4)
summary(best)
```

### Are the weekday effects significant in the returns at the 5% level?

+ 星期一、二、五在上面每個模型中，p-value 均小於0.05，故這幾天顯著影響報酬率
+ 但其實大部分的模型每天對報酬率都有顯著影響，AIC間也變化不大

(b) Use the HAC estimator of the covariance matrix to obtain the t ratio of <br>
regression estimates. Does the HAC estimator change the conclusion of weekday effects? 

```{r}
coeftest(best, vcov=vcovHAC(best))
```

+ By using the HAC estimator, it doesn’t change the conclusion of weekday effects.
+ 仍是 M、T、F 影響顯著

## 2.
Now consider similar questions of the previous exercise for the IBM <br>
stock returns.(d-ibm3dxwkdays8008.txt) <br><br>

(c) Refine the above model by using the technique of regression model <br>
with time series errors. In there a significant weekday effect based <br>
on the refined model?

```{r}
ibm = lm(ibm ~ M + T + W + R + F ,data=data4)
summary(ibm)
```

+ model:$R_t = -0.0005902 + 0.0025896M + 0.0020296T + 0.0002289W + 0.0006073R$
+ 星期一和星期二在不考慮星期五影響下 p-value < 0.05，顯著影響報酬率

```{r}
acf(ibm$residuals)
```

### serial correlations in the residuals

+ Use Q(12) to perform the test

```{r}
Box.test(ibm$residuals,lag=12,type='Ljung')
```

+ NO，因為 p-value > 0.05，不拒絕 H0 (無序列相關)

```{r}
eacf(ibm$residuals)
```

### MA(1)

```{r}
estmodel1 = arima(data4$ibm, order = c(0,0,1),
                  xreg = data4$M + data4$T)
estmodel1
```

```{r}
rbind(estmodel1$coef-2*sqrt(diag(estmodel1$var.coef)),estmodel1$coef+2*sqrt(diag(estmodel1$var.coef)))
```

```{r}
estmodel2 = arima(data4$ibm, order = c(0,0,1),
                  xreg = data4$M + data4$T,
                  fixed=c(NA,0,NA))
estmodel2
```

```{r}
Box.test(estmodel2$residuals, lag=12, type="Ljung")
```

```{r}
estmodel2$coef
estmodel2$var.coef
```
$$H_0 : \beta = 0$$
$$t = \frac{\hat{\beta}-0}{stdev(\hat{\beta})}$$

```{r}
t_ibm = estmodel2$coef[3]/sqrt(estmodel2$var.coef[2,2])
t_ibm
```

```{r}
p_value = 2*(1-pnorm(t_ibm))
cbind(test_statistic=t_ibm, p_value=p_value)
```

+ There is a significant weekday effect based on the refined model since p-value < 0.05

## 3. 
Again, consider the two bond yield series, that is, Aaa and Baa. What <br> 
is the relationship between the two series? To answer this question, <br>
build a time series model using yields of Aaa bonds as the dependent <br>
variable and yields of Baa bonds as independent variable

```{r}
Aaa = read.table("C:/Users/user/Desktop/time_series/HW/w-Aaa.txt",header = F)
head(Aaa)

Baa = read.table("C:/Users/user/Desktop/time_series/HW/w-Baa.txt",header = F)
head(Baa)
```

```{r}
plot(ts(Aaa$V4))
acf(Aaa$V4)
plot(ts(Baa$V4))
acf(Baa$V4)
```

```{r}
a = diff(Aaa$V4)
b = diff(Baa$V4)

par(mfrow=c(1,2))
plot(Baa$V4,Aaa$V4)
plot(b,a)
```

```{r}
reg.fit = lm(a ~ -1+b)
summary(reg.fit)
```

```{r}
acf(reg.fit$residuals, lag=36)
```

```{r}
m1 = arima(a, order=c(0,0,1), xreg=b, include.mean=F)
m1
```

```{r}
rbind(m1$coef-2*sqrt(diag(m1$var.coef)),
      m1$coef+2*sqrt(diag(m1$var.coef)))
```

```{r}
Box.test(m1$residuals, lag=12, type="Ljung")
```

+ p value<0.05，拒絕H0，序列相關，該模型不夠，(不好)

```{r}
eacf(m1$residuals)
```

### arima(2,0,4)

```{r}
m2 = arima(a, order=c(2,0,4), xreg=b, include.mean=F)
m2
```

```{r}
rbind(m2$coef-2*sqrt(diag(m2$var.coef)),
      m2$coef+2*sqrt(diag(m2$var.coef)))
```

```{r  warning=FALSE}
Box.test(m2$residuals, lag=12, type="Ljung")
plot(m2$residuals)
adfTest(diff(b))
```

+ p value<0.05，拒絕H0，序列相關，該模型不夠，(不好)，但有進步

$$H_0 : \beta = 0$$
$$t = \frac{\hat{\beta}-0}{stdev(\hat{\beta})}$$

```{r}
m2$coef
m2$var.coef
```

```{r}
t_ibm2 = m2$coef[7]/sqrt(m2$var.coef[7,7])
t_ibm2
```

```{r}
p_value2 = 2*(1-pnorm(t_ibm2))
cbind(test_statistic=t_ibm2, p_value=p_value2)
```

+ p-value為0, Aaa、Baa H(A)C 顯著相關

---
---
